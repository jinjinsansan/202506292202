# かんじょうにっき - 開発ガイド

## 🎯 開発継続のための重要情報

### ⚠️ 重要な制約事項（必須遵守）
```
# 開発時の注意点
- pages ディレクトリ以外は変更しないこと
- Tailwind 設定ファイルに手を加えないこと
- 新しい依存パッケージはインストールしないこと
- supabase/migrations/ 内のファイルは変更しないこと
```

## 🚀 現在の開発状況（2025年6月29日時点）

### ✅ 完成済み機能
- **感情日記システム**: 作成・編集・削除・検索機能
- **無価値感推移グラフ**: データ可視化とSNSシェア
- **カウンセラー管理画面**: 
  - 日記管理・高度検索・カレンダー検索
  - カウンセラーメモ機能
  - 担当者割り当て・緊急度管理
- **自動同期システム**: ローカル↔Supabase自動同期
- **同意履歴管理**: プライバシーポリシー同意の完全追跡
- **デバイス認証システム**: PIN番号認証、秘密の質問、セキュリティダッシュボード
- **データバックアップ・復元機能**: ローカルデータのバックアップと復元
- **レスポンシブデザイン**: 全デバイス対応
- **ポジティブ感情対応**: 嬉しい、感謝、達成感、幸せなどのポジティブ感情にも対応
- **ローカルモード**: Supabase接続なしでも動作可能なモード

## 🆕 新機能の詳細

### 自動同期システム
- **場所**: `src/hooks/useAutoSync.ts`, `src/components/DataMigration.tsx`
- **機能**: 
  - アプリ起動時の自動ユーザー作成・確認
  - 5分間隔でのローカルデータ自動同期
  - 手動同期オプション
  - エラーハンドリングと状態表示
- **使用方法**: `src/App.tsx`で`useAutoSync()`フックを呼び出し済み

### 同意履歴管理
- **場所**: `src/components/ConsentHistoryManagement.tsx`
- **機能**:
  - プライバシーポリシー同意の完全追跡
  - 法的要件に対応した履歴保存
  - CSV出力機能
  - 管理画面での一覧・検索機能
- **データ**: `consent_histories`テーブルとローカルストレージ

### デバイス認証システム
- **場所**: `src/lib/deviceAuth.ts`, `src/components/DeviceAuthLogin.tsx`
- **機能**:
  - デバイスフィンガープリント生成・照合
  - PIN番号認証（6桁）
  - 秘密の質問による復旧機能
  - アカウントロック機能（5回失敗で24時間ロック）
  - セキュリティイベントログ
  - デバイス認証管理画面
  - セキュリティダッシュボード

### カウンセラーコメント機能
- **場所**: `src/components/AdminPanel.tsx`, `src/pages/DiarySearchPage.tsx`
- **機能**:
  - カウンセラーメモをユーザーに表示する機能
  - カウンセラー名の表示
  - 表示/非表示の切り替え
  - ユーザー検索画面での表示

### データバックアップ・復元機能
- **場所**: `src/components/UserDataManagement.tsx`, `src/components/AdminBackupRestore.tsx`
- **機能**:
  - ローカルデータのJSONバックアップ
  - バックアップファイルからの復元
  - 端末変更時のデータ移行サポート
  - 管理者向け全体バックアップ機能

### ポジティブ感情対応
- **場所**: `src/pages/DiaryPage.tsx`, `src/pages/EmotionTypes.tsx`
- **機能**:
  - 嬉しい、感謝、達成感、幸せなどのポジティブ感情を追加
  - 感情選択UIの改善（ネガティブ/ポジティブのセクション分け）
  - 感情タイプ説明ページの拡充
  - ポジティブ感情のスコア記録

### ローカルモード
- **場所**: `src/lib/supabase.ts`
- **機能**:
  - Supabase接続なしでも動作可能
  - 環境変数による簡単な切り替え
  - オフライン環境でも利用可能

## 🔧 環境変数設定
```env
# Supabase設定（必須）
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key

# ローカルモード設定（オプション）
VITE_LOCAL_MODE=false

# メンテナンスモード設定（オプション）
VITE_MAINTENANCE_MODE=false
VITE_MAINTENANCE_MESSAGE=システムメンテナンス中です
VITE_MAINTENANCE_END_TIME=2025-01-22T10:00:00Z
```

## 👥 カウンセラーアカウント
| メールアドレス | パスワード |
|----------------|------------|
| jin@namisapo.com (心理カウンセラー仁) | counselor123 |
| aoi@namisapo.com (心理カウンセラーAOI) | counselor123 |
| asami@namisapo.com (心理カウンセラーあさみ) | counselor123 |
| shu@namisapo.com (心理カウンセラーSHU) | counselor123 |
| yucha@namisapo.com (心理カウンセラーゆーちゃ) | counselor123 |
| sammy@namisapo.com (心理カウンセラーSammy) | counselor123 |

## 🔍 トラブルシューティング

### よくある問題
1. **Supabase接続エラー**: 環境変数の確認
2. **自動同期が動作しない**: ブラウザのコンソールでエラー確認、ローカルモード設定の確認
3. **カウンセラーログインできない**: パスワード`counselor123`を確認
4. **バックアップが復元できない**: ファイル形式の確認

### デバッグ方法
- ブラウザのコンソールでエラーを確認
- ローカルストレージの内容を確認
- 開発者ツールのネットワークタブでAPI通信を確認
- ローカルモード設定を確認

## 🎯 次回開発時の推奨アクション

1. **環境確認**: `npm run dev`でローカル環境が正常に動作することを確認
2. **Supabase接続**: 環境変数を設定してSupabase接続を確認
3. **自動同期テスト**: 新しいユーザーでアプリを開いて自動同期をテスト
4. **機能テスト**: 日記作成、検索、管理画面の動作確認
5. **新機能開発**: 既存の制約事項を守りながら新機能を追加
6. **デバイス認証テスト**: 管理画面の「デバイス認証」「セキュリティ」タブの確認
7. **データバックアップテスト**: バックアップ作成と復元機能の確認

---

**一般社団法人NAMIDAサポート協会**  
テープ式心理学による心の健康サポート